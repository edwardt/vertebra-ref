<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
  <html>
    <head>
      <title>Example Workflow</title>
      <link rel="stylesheet" href="base.css" type="text/css" media="screen" />
      <link rel="stylesheet" href="workflow.css" type="text/css" media="screen" />
      <script type="text/javascript" src="jquery.js"></script>
      <script type="text/javascript" src="interact.js"></script>
    </head>
    <body>
      <div id="wrap">
      <div id="escapedxml"><div class="pad">
        <h1 class="title">Example Workflow</h1>
        <div class="xmlcontent"><pre>
<span class="hotzone" target="workflow"><span class="tag">&lt;<span class="tagname" class="tag_workflow">workflow</span> <span class="attrkey">name</span>=<span class="attrval">"/sales/accept_order"</span> <span class="attrkey">start</span>=<span class="attrval">"get_data"</span>&gt;</span>
  Sales: Receive Order

  Receives an order and gets things rolling.

  <span class="hotzone" target="global,import"><span class="tag">&lt;<span class="tagname" class="tag_import">import</span>&gt;</span>
    <span class="hotzone" target="type,res,assert"><span class="tag">&lt;<span class="tagname" class="tag_res">res</span> <span class="attrkey">assert</span>=<span class="attrval">"company"</span>&gt;</span>/company/engineyard"<span class="tag">&lt;/<span class="tagname" class="tag_res">res</span>&gt;</span></span>
    <span class="hotzone" target="type,res,assert"><span class="tag">&lt;<span class="tagname" class="tag_res">res</span> <span class="attrkey">assert</span>=<span class="attrval">"location"</span>&gt;</span>/us<span class="tag">&lt;/<span class="tagname" class="tag_res">res</span>&gt;</span></span>
    <span class="hotzone" target="type,i4,assert"><span class="tag">&lt;<span class="tagname" class="tag_i4">i4</span> <span class="attrkey">assert</span>=<span class="attrval">"api_version"</span>&gt;</span>5<span class="tag">&lt;/<span class="tagname" class="tag_i4">i4</span>&gt;</span></span>

    <span class="hotzone" target="type,string,import_from"><span class="tag">&lt;<span class="tagname" class="tag_string">string</span> <span class="attrkey">from</span>=<span class="attrval">"name"</span>&gt;</span>Id of Customer<span class="tag">&lt;/<span class="tagname" class="tag_string">string</span>&gt;</span></span>
    <span class="hotzone" target="type,string,import_from"><span class="tag">&lt;<span class="tagname" class="tag_string">string</span> <span class="attrkey">from</span>=<span class="attrval">"location"</span>&gt;</span>Resource Giving Location Information<span class="tag">&lt;/<span class="tagname" class="tag_string">string</span>&gt;</span></span>
    <span class="hotzone" target="type,list,import_from"><span class="tag">&lt;<span class="tagname" class="tag_list">list</span> <span class="attrkey">from</span>=<span class="attrval">"items"</span>&gt;</span>Line Items Ordered<span class="tag">&lt;/<span class="tagname" class="tag_list">list</span>&gt;</span></span>

    <span class="hotzone" target="type,i4,stuffed"><span class="tag">&lt;<span class="tagname" class="tag_i4">i4</span> <span class="attrkey">key</span>=<span class="attrval">"lucky_number"</span>&gt;</span>42<span class="tag">&lt;/<span class="tagname" class="tag_i4">i4</span>&gt;</span></span>
  <span class="tag">&lt;/<span class="tagname" class="tag_import">import</span>&gt;</span></span>

  <span class="comment">&lt;!-- We don't have any global &lt;export /&gt; tag --&gt;

  </span><span class="hotzone" target="state"><span class="tag">&lt;<span class="tagname" class="tag_state">state</span> <span class="attrkey">id</span>=<span class="attrval">"get_data"</span>&gt;</span>
    First, we have to load the contact data from our CRM.

    <span class="hotzone" target="op"><span class="tag">&lt;<span class="tagname" class="tag_op">op</span> <span class="attrkey">scope</span>=<span class="attrval">"single"</span> <span class="attrkey">type</span>=<span class="attrval">"/sales/crm/find_contact_data"</span>&gt;</span>
      <span class="hotzone" target="op_input"><span class="tag">&lt;<span class="tagname" class="tag_import">import</span>&gt;</span>
        <span class="tag">&lt;<span class="tagname" class="tag_string">string</span> <span class="attrkey">from</span>=<span class="attrval">"name"</span> <span class="attrkey">key</span>=<span class="attrval">"contact"</span> /&gt;</span>
        <span class="tag">&lt;<span class="tagname" class="tag_string">string</span> <span class="attrkey">key</span>=<span class="attrval">"type"</span>&gt;</span>customer<span class="tag">&lt;/<span class="tagname" class="tag_string">string</span>&gt;</span> <span class="comment">&lt;!-- hardcoded value --&gt;
      </span><span class="tag">&lt;/<span class="tagname" class="tag_import">import</span>&gt;</span></span>
      <span class="hotzone" target="op_export"><span class="tag">&lt;<span class="tagname" class="tag_export">export</span>&gt;</span>
        <span class="tag">&lt;<span class="tagname" class="tag_first">first</span> <span class="attrkey">key</span>=<span class="attrval">"contact_id"</span> <span class="attrkey">to</span>=<span class="attrval">"cust_id"</span> /&gt;</span>
	<span class="tag">&lt;<span class="tagname" class="tag_bool">bool</span> <span class="attrkey">assert</span>=<span class="attrval">"error"</span>&gt;</span>false<span class="tag">&lt;/<span class="tagname" class="tag_bool">bool</span>&gt;</span><span class="comment">&lt;!-- asserted output --&gt;
      </span><span class="tag">&lt;/<span class="tagname" class="tag_export">export</span>&gt;</span></span>
    <span class="tag">&lt;/<span class="tagname" class="tag_op">op</span>&gt;</span></span>
    <span class="tag">&lt;<span class="tagname" class="tag_emit">emit</span>&gt;</span>
      <span class="tag">&lt;<span class="tagname" class="tag_string">string</span> <span class="attrkey">key</span>=<span class="attrval">"message"</span>&gt;</span>Located customer data...<span class="tag">&lt;/<span class="tagname" class="tag_string">string</span>&gt;</span>
      <span class="tag">&lt;<span class="tagname" class="tag_string">string</span> <span class="attrkey">from</span>=<span class="attrval">"contact_id"</span> /&gt;</span>
    <span class="tag">&lt;/<span class="tagname" class="tag_emit">emit</span>&gt;</span>
    <span class="tag">&lt;<span class="tagname" class="tag_trans">trans</span>&gt;</span>
      <span class="tag">&lt;<span class="tagname" class="tag_state">state</span>&gt;</span>process_data<span class="tag">&lt;/<span class="tagname" class="tag_state">state</span>&gt;</span>
    <span class="tag">&lt;/<span class="tagname" class="tag_trans">trans</span>&gt;</span>
  <span class="tag">&lt;/<span class="tagname" class="tag_state">state</span>&gt;</span></span>

  <span class="tag">&lt;<span class="tagname" class="tag_state">state</span> <span class="attrkey">id</span>=<span class="attrval">"process_data"</span>&gt;</span>
    Now we dispatch the order to the CRM. emit some status, and a log.

    <span class="tag">&lt;<span class="tagname" class="tag_op">op</span> <span class="attrkey">scope</span>=<span class="attrval">"single"</span> <span class="attrkey">type</span>=<span class="attrval">"/sales/crm/add_order"</span>&gt;</span>
      <span class="tag">&lt;<span class="tagname" class="tag_import">import</span>&gt;</span>
        <span class="tag">&lt;<span class="tagname" class="tag_string">string</span> <span class="attrkey">from</span>=<span class="attrval">"cust_id"</span> <span class="attrkey">key</span>=<span class="attrval">"contact_id"</span> /&gt;</span>
      	<span class="tag">&lt;<span class="tagname" class="tag_list">list</span> <span class="attrkey">from</span>=<span class="attrval">"items"</span> /&gt;</span> <span class="comment">&lt;!-- key defaults to imported key --&gt;
      </span><span class="tag">&lt;/<span class="tagname" class="tag_import">import</span>&gt;</span>
      <span class="tag">&lt;<span class="tagname" class="tag_export">export</span>&gt;</span>
        <span class="tag">&lt;<span class="tagname" class="tag_first">first</span> <span class="attrkey">key</span>=<span class="attrval">"order_id"</span> /&gt;</span>
        <span class="tag">&lt;<span class="tagname" class="tag_first">first</span> <span class="attrkey">key</span>=<span class="attrval">"confirmation_code"</span> <span class="attrkey">to</span>=<span class="attrval">"ccode"</span> /&gt;</span>
      <span class="tag">&lt;/<span class="tagname" class="tag_export">export</span>&gt;</span>
    <span class="tag">&lt;/<span class="tagname" class="tag_op">op</span>&gt;</span>
    <span class="tag">&lt;<span class="tagname" class="tag_emit">emit</span> <span class="attrkey">log_keys</span>=<span class="attrval">"app,location,cust_id,order_id"</span> <span class="attrkey">log_vals</span>=<span class="attrval">"ccode"</span>&gt;</span>
      <span class="tag">&lt;<span class="tagname" class="tag_res">res</span> <span class="attrkey">key</span>=<span class="attrval">"app"</span>&gt;</span>/sales/crm<span class="tag">&lt;/<span class="tagname" class="tag_res">res</span>&gt;</span>
      <span class="tag">&lt;<span class="tagname" class="tag_string">string</span> <span class="attrkey">from</span>=<span class="attrval">"cust_id"</span> /&gt;</span>
      <span class="tag">&lt;<span class="tagname" class="tag_string">string</span> <span class="attrkey">from</span>=<span class="attrval">"location"</span> /&gt;</span>
      <span class="tag">&lt;<span class="tagname" class="tag_string">string</span> <span class="attrkey">from</span>=<span class="attrval">"order_id"</span> /&gt;</span>
      <span class="tag">&lt;<span class="tagname" class="tag_string">string</span> <span class="attrkey">from</span>=<span class="attrval">"ccode"</span> /&gt;</span>
      <span class="tag">&lt;<span class="tagname" class="tag_string">string</span> <span class="attrkey">key</span>=<span class="attrval">"message"</span>&gt;</span>Order accepted. Finding contacts.<span class="tag">&lt;/<span class="tagname" class="tag_string">string</span>&gt;</span>
    <span class="tag">&lt;/<span class="tagname" class="tag_emit">emit</span>&gt;</span>
    <span class="tag">&lt;<span class="tagname" class="tag_trans">trans</span>&gt;</span>
      <span class="tag">&lt;<span class="tagname" class="tag_state">state</span>&gt;</span>build-notify-list<span class="tag">&lt;/<span class="tagname" class="tag_state">state</span>&gt;</span>
    <span class="tag">&lt;/<span class="tagname" class="tag_trans">trans</span>&gt;</span>
  <span class="tag">&lt;/<span class="tagname" class="tag_state">state</span>&gt;</span>

  <span class="tag">&lt;<span class="tagname" class="tag_state">state</span> <span class="attrkey">id</span>=<span class="attrval">"build-notify-list"</span>&gt;</span>
    Here, we lookup who needs to be notified.

    <span class="tag">&lt;<span class="tagname" class="tag_op">op</span> <span class="attrkey">scope</span>=<span class="attrval">"all"</span> <span class="attrkey">type</span>=<span class="attrval">"/data/lookup"</span>&gt;</span>
      <span class="tag">&lt;<span class="tagname" class="tag_import">import</span>&gt;</span>
        <span class="tag">&lt;<span class="tagname" class="tag_res">res</span> <span class="attrkey">key</span>=<span class="attrval">"list"</span>&gt;</span>/notify/orders<span class="tag">&lt;/<span class="tagname" class="tag_res">res</span>&gt;</span>
        <span class="tag">&lt;<span class="tagname" class="tag_string">string</span> <span class="attrkey">from</span>=<span class="attrval">"cust_id"</span> <span class="attrkey">key</span>=<span class="attrval">"customer"</span> /&gt;</span>
      <span class="tag">&lt;/<span class="tagname" class="tag_import">import</span>&gt;</span>

      <span class="tag">&lt;<span class="tagname" class="tag_export">export</span>&gt;</span><span class="comment">&lt;!-- Here we actually concatenate multiple lists --&gt;
        </span><span class="tag">&lt;<span class="tagname" class="tag_list">list</span> <span class="attrkey">extend</span>=<span class="attrval">"contacts"</span>&gt;</span><span class="tag">&lt;<span class="tagname" class="tag_email">email</span>&gt;</span>bob@bob.com<span class="tag">&lt;/<span class="tagname" class="tag_email">email</span>&gt;</span><span class="tag">&lt;/<span class="tagname" class="tag_list">list</span>&gt;</span>
      <span class="tag">&lt;/<span class="tagname" class="tag_export">export</span>&gt;</span>
    <span class="tag">&lt;/<span class="tagname" class="tag_op">op</span>&gt;</span>

    <span class="tag">&lt;<span class="tagname" class="tag_op">op</span> <span class="attrkey">scope</span>=<span class="attrval">"all"</span> <span class="attrkey">type</span>=<span class="attrval">"/data/lookup"</span>&gt;</span><span class="comment">&lt;!-- This op runs in parallel --&gt;
      </span><span class="tag">&lt;<span class="tagname" class="tag_import">import</span>&gt;</span>
	<span class="tag">&lt;<span class="tagname" class="tag_res">res</span> <span class="attrkey">key</span>=<span class="attrval">"list"</span>&gt;</span>/notify/orders<span class="tag">&lt;/<span class="tagname" class="tag_res">res</span>&gt;</span>
      	<span class="tag">&lt;<span class="tagname" class="tag_res">res</span> <span class="attrkey">key</span>=<span class="attrval">"department"</span>&gt;</span>/sales<span class="tag">&lt;/<span class="tagname" class="tag_res">res</span>&gt;</span>
      	<span class="tag">&lt;<span class="tagname" class="tag_res">res</span> <span class="attrkey">from</span>=<span class="attrval">"location"</span> /&gt;</span>
      <span class="tag">&lt;/<span class="tagname" class="tag_import">import</span>&gt;</span>

      <span class="tag">&lt;<span class="tagname" class="tag_export">export</span>&gt;</span><span class="comment">&lt;!-- and we keep adding to the same list --&gt;
        </span><span class="tag">&lt;<span class="tagname" class="tag_list">list</span> <span class="attrkey">extend</span>=<span class="attrval">"contacts"</span>&gt;</span><span class="tag">&lt;<span class="tagname" class="tag_email">email</span> /&gt;</span><span class="tag">&lt;/<span class="tagname" class="tag_list">list</span>&gt;</span>
      <span class="tag">&lt;/<span class="tagname" class="tag_export">export</span>&gt;</span>
    <span class="tag">&lt;/<span class="tagname" class="tag_op">op</span>&gt;</span>

    <span class="tag">&lt;<span class="tagname" class="tag_emit">emit</span>&gt;</span>
      <span class="tag">&lt;<span class="tagname" class="tag_string">string</span> <span class="attrkey">key</span>=<span class="attrval">"message"</span>&gt;</span>Notifying contacts.<span class="tag">&lt;/<span class="tagname" class="tag_string">string</span>&gt;</span>
    <span class="tag">&lt;/<span class="tagname" class="tag_emit">emit</span>&gt;</span>

    <span class="tag">&lt;<span class="tagname" class="tag_trans">trans</span>&gt;</span>
      <span class="tag">&lt;<span class="tagname" class="tag_state">state</span>&gt;</span>notify<span class="tag">&lt;/<span class="tagname" class="tag_state">state</span>&gt;</span>
    <span class="tag">&lt;/<span class="tagname" class="tag_trans">trans</span>&gt;</span>
  <span class="tag">&lt;/<span class="tagname" class="tag_state">state</span>&gt;</span>

  <span class="tag">&lt;<span class="tagname" class="tag_state">state</span> <span class="attrkey">id</span>=<span class="attrval">"notify"</span>&gt;</span>
    And we send the notifications.

    <span class="tag">&lt;<span class="tagname" class="tag_op">op</span> <span class="attrkey">scope</span>=<span class="attrval">"single"</span> <span class="attrkey">type</span>=<span class="attrval">"/comms/mailer"</span>&gt;</span>
      <span class="tag">&lt;<span class="tagname" class="tag_import">import</span>&gt;</span>
        <span class="tag">&lt;<span class="tagname" class="tag_list">list</span> <span class="attrkey">each</span>=<span class="attrval">"contacts"</span> /&gt;</span>
	<span class="tag">&lt;<span class="tagname" class="tag_string">string</span> <span class="attrkey">key</span>=<span class="attrval">"message"</span>&gt;</span>...<span class="tag">&lt;/<span class="tagname" class="tag_string">string</span>&gt;</span>
      <span class="tag">&lt;/<span class="tagname" class="tag_import">import</span>&gt;</span>
    <span class="tag">&lt;/<span class="tagname" class="tag_op">op</span>&gt;</span>

    <span class="tag">&lt;<span class="tagname" class="tag_emit">emit</span>&gt;</span>
      <span class="tag">&lt;<span class="tagname" class="tag_string">string</span> <span class="attrkey">key</span>=<span class="attrval">"Message"</span>&gt;</span>
        Order complete.
	.... (some sort of string interpolation potentially) ...
      <span class="tag">&lt;/<span class="tagname" class="tag_string">string</span>&gt;</span>
    <span class="tag">&lt;/<span class="tagname" class="tag_emit">emit</span>&gt;</span>

    <span class="tag">&lt;<span class="tagname" class="tag_trans">trans</span>&gt;</span>
      <span class="tag">&lt;<span class="tagname" class="tag_done">done</span> /&gt;</span>
    <span class="tag">&lt;/<span class="tagname" class="tag_trans">trans</span>&gt;</span>
  <span class="tag">&lt;/<span class="tagname" class="tag_state">state</span>&gt;</span>
<span class="tag">&lt;/<span class="tagname" class="tag_workflow">workflow</span>&gt;</span></span>        </pre></div>
      </div></div>
      <div id="commentaccordian"><div class="pad">
        <div class="commenthdr" id="header"><p>Click title to see all comments.</p><p>Click individual element text to reveal comments limited to a certain location.</p></div>
        <div class="commenthdr" id="toc"><h3 id="toctitle">Contents</h3><ul id="toclist"></ul></div>
        <div class="commentbox" id="comment_workflow">
    <h3 class="tochead">Workflow</h3>
    <p>This is the definition for a Vertebra workflow.  Workflows are executed
by Cavalcade in a fault-tolerant manner.  The top-level 'workflow' element has
a number of attributes as follows:</p>
    <ul>
      <li>name &#8212; the operation that this workflow offers</li>
      <li>start &#8212; the initial state of the workflow</li>
    </ul>
  </div>
        <div class="commentbox" id="comment_global">
    <h3 class="tochead">Global Import</h3>
    <p>This import element specifies all of the inputs, hardcoded values, and
assertions about the operation as a whole.  Essentially, each subelement says
something about the input to the workflow operation.</p>
  </div>
        <div class="commentbox" id="comment_assert">
    <h4 class="tochead">Asserted Values</h4>
    <p>For example, a data value with an "assert" annotation indicates that
this workflow asserts that this value must be present for this workflow to be
triggered.  This is most commonly used to specify that a certain tree of
resources must be matched.  If the actual resource matched is desired, the
"from" annotation may be used on the same element.</p>
  </div>
        <div class="commentbox" id="comment_import_from">
    <h4 class="tochead">Imported Values</h4>
    <p>A "from" annotation indicates that an input should be copied from the
input key with the value of the "from" attribute into an initial state-value
for the workflow.  By default, the key is the same as the one imported from.
If a "to" annotation is specified as well, then the state-value is keyed on the
value of the "to" annotation instead.</p>
  </div>
        <div class="commentbox" id="comment_stuffed">
    <h4 class="tochead">Default Values</h4>
    <p>A value annotated simply with a "key" is imported into the initial
state-hash as a default value.  It need not be present in the operation that
triggers the workflow.</p>
  </div>
        <div class="commentbox" id="comment_type">
    <h3 class="tochead">Data Type</h3>
    <p>Data type tags indicate how a piece of data is to be marshalled.  Beyond
checking the validity of the tag, Cavalcade handles very few data-types
directly, and can't be relied upon to validate the internal structure of an XML
element.  Element types which are not understood are marked as "opaque", while those that are understood are marked "transparent".</p>
  </div>
        <div class="commentbox" id="comment_res">
    <h4 class="tochead">Resource (transparent)</h4>
    <p>This data-type indicates a Vertebra resource.  A full description of
resources is outside the scope of this document.  For the purposes of matching,
a resource or any of its children will match (in the case of an "assert"
annotation).  For the purposes of importing, a resource is either passed
through literally (in the case of a "key" annotation) or the actual resource
matched is passed through (in the case of a "from" annotation).</p>
  </div>
        <div class="commentbox" id="comment_string">
    <h4 class="tochead">String (transparent)</h4>
    <p>The String data-type is simply an embedded unicode string.</p>
  </div>
        <div class="commentbox" id="comment_i4">
    <h4 class="tochead">Integer, 32-bit (transparent)</h4>
    <p>The integer data-type is a 32-bit, signed integer represented as a string of numerical characters.</p>
  </div>
        <div class="commentbox" id="comment_list">
    <h4 class="tochead">List (transparent)</h4>
    <p>A list is simply the list built up of all of the sub-elements, appropriately unmarshalled.</p>
  </div>
        <div class="commentbox" id="comment_struct">
    <h4 class="tochead">Struct (transparent)</h4>
    <p>A struct is simply the hash built up of all of the sub-elements, appropriately unmarshalled, and keyed by their "key" attribute".</p>
  </div>
      </div></div>
    </div>
  </body>
</html>
